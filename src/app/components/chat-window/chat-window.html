<div class="chat-window-container">
  
  <!-- Header -->
  <header class="chat-header" role="banner">
    <div class="container">
      <div class="header-info" aria-label="Resilience AI Coach header">
        <h2>üß† Resilience AI Coach</h2>
        <p>Your private, offline wellness companion</p>
      </div>
      
      <div class="status-indicators">
        <div class="status-item" [class.active]="isModelReady">
          <span class="status-dot"></span>
          <span role="status" aria-live="polite">{{ isModelReady ? 'Model Ready' : 'Model Not Ready' }}</span>
        </div>
        
        <div class="status-item" [class.active]="isChatReady && isModelReady">
          <span class="status-dot"></span>
          <span role="status" aria-live="polite">{{ isChatReady && isModelReady ? aiDevice : 'AI Initializing' }}</span>
        </div>

        <div class="status-item" [class.active]="headTts.isSupported()">
          <span class="status-dot"></span>
          <span role="status" aria-live="polite">{{ headTts.isSupported() ? 'TTS Ready' : 'TTS Not Available' }}</span>
        </div>
      </div>
    </div>
  </header>

  <!-- Model Selector Section (shown when no model is loaded) -->
  <div *ngIf="showModelSelector" class="model-selector-section">
    <div class="container">
      <app-model-selector
        [availableModels]="availableModels"
        [currentModel]="aiState.currentModel || null"
        [isLoading]="aiState.isLoading"
        [isInitialized]="aiState.isInitialized"
        [progress]="aiState.progress"
        [progressText]="aiState.progressText"
        (modelSelected)="onModelSelected($event)"
        (initializeTriggered)="onInitializeTriggered()">
      </app-model-selector>
    </div>
  </div>

  <!-- Main Chat Interface (shown when model is ready) -->
  <div *ngIf="!showModelSelector" class="chat-interface">
    <div class="container">
      <div class="card fade-in chat-main-content">
      <!-- Avatar and Chat Side-by-Side Layout -->
      <div class="avatar-section" *ngIf="avatarEnabled">
        <app-avatar 
          [size]="200" 
          [isVisible]="avatarEnabled">
        </app-avatar>
        
        <!-- TTS Controls -->
        <div class="tts-controls">
          <button 
            class="control-btn" 
            [class.active]="autoSpeakReplies"
            (click)="toggleAutoSpeak()"
            title="Toggle Auto-speak Replies">
            üîä Auto-speak
          </button>
          
          <button 
            class="control-btn" 
            *ngIf="ttsState.isSpeaking"
            (click)="stopSpeaking()"
            title="Stop Speaking">
            ‚èπÔ∏è Stop
          </button>
          
          <button 
            class="control-btn" 
            (click)="toggleAvatar()"
            title="Toggle Avatar">
            üë§ Avatar
          </button>
        </div>
      </div>

      <!-- Chat Messages Section -->
      <div class="messages-section">
        <!-- Chat Messages -->
        <div class="chat-messages" #messagesContainer>
          
          <!-- Welcome Message (when no conversation history) -->
          <div *ngIf="messages.length === 0" class="welcome-message">
            <div class="welcome-content">
              <div class="welcome-icon">üåü</div>
              <h3>{{ getGreeting() }} Welcome to Resilience AI</h3>
              <p>I'm here to support your mental wellness journey. Our conversations are completely private and happen offline on your device.</p>
              
              <div class="conversation-starters">
                <h4>You can ask me about:</h4>
                <div class="starter-tags">
                  <span class="starter-tag" (click)="userInput='I feel stressed about work'; sendMessage()">Stress management</span>
                  <span class="starter-tag" (click)="userInput='I have trouble sleeping'; sendMessage()">Sleep improvement</span>
                  <span class="starter-tag" (click)="userInput='How can I practice mindfulness?'; sendMessage()">Mindfulness techniques</span>
                  <span class="starter-tag" (click)="userInput='How can I build resilience?'; sendMessage()">Building resilience</span>
                  <span class="starter-tag" (click)="userInput='Help me set goals'; sendMessage()">Goal setting</span>
                  <span class="starter-tag" (click)="userInput='I need emotional support'; sendMessage()">Emotional support</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Conversation Messages -->
          <div *ngFor="let message of messages; trackBy: messageTrackBy" 
               class="message-wrapper" 
               [class.user-message]="message.role === 'user'"
               [class.ai-message]="message.role === 'assistant'">
            
            <div class="message-bubble">
              <!-- Message Header -->
              <div class="message-header">
                <span class="message-sender">
                  {{ message.role === 'user' ? 'You' : 'RAI Coach' }}
                </span>
                <span class="message-time">
                  {{ message.timestamp | date:'short' }}
                </span>
                <!-- Speak Button for AI messages -->
                <button 
                  *ngIf="message.role === 'assistant' && headTts.isSupported()" 
                  class="speak-btn"
                  (click)="speakMessage(message)"
                  [disabled]="ttsState.isSpeaking"
                  title="Speak this message">
                  üîä
                </button>
              </div>
              
              <!-- Message Content -->
              <div class="message-content">
                {{ message.content }}
              </div>
            </div>
          </div>

          <!-- Typing Indicator -->
          <div *ngIf="isGenerating" class="typing-indicator">
            <div class="typing-bubble">
              <div class="typing-dots">
                <span></span>
                <span></span>
                <span></span>
              </div>
              <span class="typing-text">RAI Coach is thinking...</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Input Section -->
    <div class="chat-input-section">
      <div class="input-container">
        <textarea 
          [(ngModel)]="userInput"
          (keydown)="onKeyPress($event)"
          placeholder="Share what's on your mind... (Press Enter to send, Shift+Enter for new line)"
          class="message-input"
          rows="2"
          [disabled]="isGenerating"
          #messageInput>
        </textarea>
        
        <button 
          (click)="sendMessage()" 
          [disabled]="!userInput.trim() || isGenerating || !isChatReady"
          class="send-button"
          title="Send Message">
          <span *ngIf="!isGenerating">‚û§</span>
          <span *ngIf="isGenerating" class="loading-spinner">‚ü≥</span>
        </button>
      </div>
      
      <!-- Input Status -->
      <div class="input-status" *ngIf="!isChatReady">
        <span class="status-text">‚è≥ Waiting for AI model to initialize...</span>
      </div>
    </div>
      
      <!-- Debug Info (only in development) -->
      <div class="debug-info" *ngIf="false">
        <details>
          <summary>üîß Debug Information</summary>
          <div class="debug-content">
            <h4>AI State:</h4>
            <pre>{{ aiState | json }}</pre>
            
            <h4>TTS State:</h4>
            <pre>{{ ttsState | json }}</pre>
            
            <h4>TTS Info:</h4>
            <pre>{{ getTTSInfo() | json }}</pre>
          </div>
        </details>
      </div>
    </div>
  </div>
</div>
